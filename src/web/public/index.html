<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WhatsApp Sales Operator â€” Dashboard</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#0a0a1a;color:#e0e0e0;min-height:100vh}
.container{max-width:1500px;margin:0 auto;padding:15px}
header{background:#111;padding:15px 20px;border-radius:10px;margin-bottom:15px;display:flex;justify-content:space-between;align-items:center;border:1px solid #222}
header h1{color:#25D366;font-size:20px}
.status{display:flex;align-items:center;gap:8px;font-size:13px}
.dot{width:10px;height:10px;border-radius:50%;background:#f44}
.dot.on{background:#25D366}
.tabs{display:flex;gap:6px;margin-bottom:15px;flex-wrap:wrap}
.tab{padding:10px 18px;background:#151525;border:1px solid #222;color:#aaa;border-radius:6px;cursor:pointer;font-size:13px;transition:.2s}
.tab:hover,.tab.active{background:#25D366;color:#000;border-color:#25D366}
.panel{display:none;background:#111;padding:18px;border-radius:10px;border:1px solid #222}
.panel.active{display:block}
.card{background:#0d1a30;padding:16px;border-radius:8px;margin-bottom:14px;border:1px solid #1a2a40}
.card h3{margin-bottom:12px;color:#25D366;font-size:15px}
input,textarea,select{width:100%;padding:10px;border:1px solid #222;border-radius:5px;background:#0a0a1a;color:#e0e0e0;margin-bottom:8px;font-size:13px}
button{padding:10px 20px;background:#25D366;border:none;border-radius:5px;color:#000;cursor:pointer;font-weight:bold;font-size:13px;transition:.2s}
button:hover{background:#128C7E;color:#fff}
.btn-danger{background:#e74c3c;color:#fff}
.btn-danger:hover{background:#c0392b}
.btn-warning{background:#f39c12;color:#000}
.btn-sm{padding:6px 12px;font-size:12px}
.btn-outline{background:transparent;border:1px solid #25D366;color:#25D366}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
th,td{padding:10px;text-align:left;border-bottom:1px solid #1a2a40}
th{color:#25D366;font-size:12px;text-transform:uppercase}
.badge{padding:3px 8px;border-radius:3px;font-size:11px;font-weight:bold}
.badge-green{background:#25D366;color:#000}
.badge-blue{background:#3498db;color:#fff}
.badge-orange{background:#f39c12;color:#000}
.badge-red{background:#e74c3c;color:#fff}
.badge-gray{background:#555;color:#fff}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:14px}
.stats{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;margin-bottom:15px}
.stat{background:#0d1a30;padding:14px;border-radius:8px;text-align:center;border:1px solid #1a2a40}
.stat .num{font-size:28px;font-weight:bold;color:#25D366}
.stat .lbl{font-size:11px;opacity:.6;margin-top:4px}
.pipeline-row{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:8px;margin:12px 0}
.stage-card{background:#0d1a30;padding:12px;border-radius:6px;text-align:center;border:1px solid #1a2a40;cursor:pointer;transition:.2s}
.stage-card:hover{border-color:#25D366}
.stage-card .count{font-size:24px;font-weight:bold;color:#25D366}
.stage-card .name{font-size:11px;opacity:.7;margin-top:4px}
.msg{padding:8px 12px;margin:4px 0;border-radius:6px;font-size:13px}
.msg.in{background:#0d1a30}
.msg.out{background:#0a3d2a;margin-left:15%}
.msg small{opacity:.5;font-size:10px}
.event{padding:6px 10px;margin:3px 0;border-radius:4px;font-size:12px;background:#0d1a30;display:flex;justify-content:space-between}
.event .type{color:#25D366;font-weight:bold}
.file-upload{border:2px dashed #25D366;padding:30px;text-align:center;border-radius:8px;cursor:pointer;margin-bottom:10px;font-size:13px}
.file-upload:hover{background:rgba(37,211,102,.05)}
.qr-section{text-align:center;padding:30px}
.qr-section img{max-width:280px;margin:15px auto;display:block}
.kill-switch{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
pre{background:#0a0a1a;padding:12px;border-radius:6px;overflow-x:auto;font-size:12px;max-height:400px;overflow-y:auto;border:1px solid #222}
@media(max-width:768px){.stats{grid-template-columns:repeat(2,1fr)}.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
<header>
    <h1>ğŸ“± WhatsApp Sales Operator</h1>
    <div class="status"><span class="dot" id="dot"></span><span id="statusTxt">...</span></div>
</header>

<div class="stats" id="kpiBar"></div>

<div class="tabs">
    <button class="tab active" onclick="show('dash')">ğŸ“Š Dashboard</button>
    <button class="tab" onclick="show('pipeline')">ğŸ”„ Pipeline</button>
    <button class="tab" onclick="show('contacts')">ğŸ“‡ Contacts</button>
    <button class="tab" onclick="show('send')">ğŸ“¤ Send</button>
    <button class="tab" onclick="show('kb')">ğŸ“š Knowledge</button>
    <button class="tab" onclick="show('events')">ğŸ“‹ Events</button>
    <button class="tab" onclick="show('settings')">âš™ï¸ Settings</button>
    <button class="tab" onclick="show('connect')">ğŸ”— Connect</button>
</div>

<!-- Dashboard -->
<div class="panel active" id="dash-panel">
    <div class="card"><h3>ğŸ”„ Pipeline Overview</h3><div class="pipeline-row" id="pipelineOverview"></div></div>
    <div class="grid">
        <div class="card"><h3>ğŸš¨ Needs Human Attention</h3><div id="humanList"></div></div>
        <div class="card"><h3>ğŸ“‹ Recent Events</h3><div id="recentEvents"></div></div>
    </div>
</div>

<!-- Pipeline -->
<div class="panel" id="pipeline-panel">
    <div class="card"><h3>ğŸ”„ Pipeline Stages</h3><div class="pipeline-row" id="pipelineDetailed"></div></div>
    <div class="card"><h3>Contacts in Stage</h3>
        <input type="text" id="stageFilter" placeholder="Click a stage above to filter..." readonly>
        <table><thead><tr><th>Phone</th><th>Name</th><th>Stage</th><th>Consent</th><th>Risk</th><th>Actions</th></tr></thead>
        <tbody id="stageContacts"></tbody></table>
    </div>
</div>

<!-- Contacts -->
<div class="panel" id="contacts-panel">
    <div class="grid">
        <div class="card"><h3>â• Add Contact</h3>
            <input id="cPhone" placeholder="Phone (country code, no +)">
            <input id="cName" placeholder="Name"><input id="cCompany" placeholder="Company">
            <button onclick="addContact()">Add</button>
        </div>
        <div class="card"><h3>ğŸ“ Batch Import</h3>
            <div class="file-upload" onclick="document.getElementById('csvFile').click()">ğŸ“ Upload CSV (phone,name,company,email)</div>
            <input type="file" id="csvFile" accept=".csv" style="display:none" onchange="uploadCSV(this)">
            <input id="batchProject" placeholder="Pitch project (optional)">
            <input id="batchType" placeholder="Batch type (e.g. crypto_group)">
        </div>
    </div>
    <div class="card"><h3>ğŸ“‹ All Contacts</h3>
        <table><thead><tr><th>Phone</th><th>Name</th><th>Stage</th><th>Consent</th><th>Risk</th><th>Bot</th><th>Actions</th></tr></thead>
        <tbody id="contactsTable"></tbody></table>
    </div>
</div>

<!-- Send -->
<div class="panel" id="send-panel">
    <div class="card"><h3>ğŸ“¤ Send Message</h3>
        <input id="sendPhone" placeholder="Phone number">
        <textarea id="sendMsg" rows="3" placeholder="Message (auto-split at 70 chars)..."></textarea>
        <div style="font-size:12px;opacity:.6;margin-bottom:8px">Chars: <span id="cc">0</span> | Parts: <span id="pc">1</span></div>
        <button onclick="sendMsg()">Send</button>
    </div>
</div>

<!-- Knowledge -->
<div class="panel" id="kb-panel">
    <div class="card"><h3>â• Add Knowledge</h3>
        <select id="kbCat"><option value="general">General</option><option value="pricing">Pricing</option><option value="services">Services</option><option value="faq">FAQ</option><option value="company">Company</option><option value="objection">Objection Response</option></select>
        <input id="kbQ" placeholder="Question (optional)">
        <textarea id="kbA" rows="2" placeholder="Answer / Information"></textarea>
        <input id="kbKW" placeholder="Keywords (comma separated)">
        <button onclick="addKB()">Add</button>
    </div>
    <div class="card"><h3>ğŸ“š Knowledge Base</h3>
        <table><thead><tr><th>Cat</th><th>Q</th><th>Answer</th><th>X</th></tr></thead><tbody id="kbTable"></tbody></table>
    </div>
</div>

<!-- Events -->
<div class="panel" id="events-panel">
    <div class="card"><h3>ğŸ“‹ Event Timeline</h3>
        <input id="evPhone" placeholder="Filter by phone (optional)">
        <button onclick="loadEvents()">Load Events</button>
        <div id="eventsList" style="margin-top:10px;max-height:500px;overflow-y:auto"></div>
    </div>
</div>

<!-- Settings -->
<div class="panel" id="settings-panel">
    <div class="card"><h3>ğŸ›¡ï¸ Kill Switch</h3>
        <div class="kill-switch">
            <button class="btn-danger" onclick="emergencyStop()">ğŸš¨ EMERGENCY STOP</button>
            <button onclick="resumeSend()">âœ… Resume Sending</button>
            <span id="sendStatus"></span>
        </div>
    </div>
    <div class="grid">
        <div class="card"><h3>âš™ï¸ Auto-Reply</h3>
            <button id="arBtn" onclick="toggleAutoReply()">Toggle Auto-Reply</button>
            <span id="arStatus"></span>
        </div>
        <div class="card"><h3>ğŸ“Š System Settings</h3><div id="settingsList"></div></div>
    </div>
</div>

<!-- Connect -->
<div class="panel" id="connect-panel">
    <div class="card"><h3>ğŸ”— Connect WhatsApp</h3>
        <div class="qr-section">
            <p id="qrStatus">Loading...</p>
            <img id="qrImg" style="display:none">
        </div>
    </div>
</div>

<!-- Contact Detail Modal -->
<div id="modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.8);z-index:999;overflow-y:auto">
    <div style="max-width:700px;margin:50px auto;background:#111;border-radius:10px;padding:20px;border:1px solid #222">
        <div style="display:flex;justify-content:space-between"><h3 id="modalTitle" style="color:#25D366"></h3><button class="btn-sm btn-outline" onclick="closeModal()">âœ•</button></div>
        <div id="modalContent" style="margin-top:15px"></div>
    </div>
</div>
</div>

<script>
const A='/api';

// â”€â”€ Status â”€â”€
async function checkStatus(){
    try{const r=await(await fetch(A+'/status')).json();
    document.getElementById('dot').className='dot'+(r.connected?' on':'');
    document.getElementById('statusTxt').textContent=r.connected?'Connected':'Disconnected';
    }catch(e){document.getElementById('statusTxt').textContent='Offline'}
}

// â”€â”€ KPIs â”€â”€
async function loadKPIs(){
    try{const r=await(await fetch(A+'/kpis')).json();if(!r.success)return;const k=r.kpis;
    document.getElementById('kpiBar').innerHTML=`
        <div class="stat"><div class="num">${k.totalContacts}</div><div class="lbl">Contacts</div></div>
        <div class="stat"><div class="num">${k.messagesSent}</div><div class="lbl">Sent</div></div>
        <div class="stat"><div class="num">${k.messagesReceived}</div><div class="lbl">Received</div></div>
        <div class="stat"><div class="num">${k.humanRequired}</div><div class="lbl">âš ï¸ Human Needed</div></div>
        <div class="stat"><div class="num">${k.escalations}</div><div class="lbl">ğŸš¨ Escalations</div></div>
        <div class="stat"><div class="num">${k.blocked}</div><div class="lbl">ğŸ›¡ï¸ Blocked</div></div>
        <div class="stat"><div class="num" style="color:${k.globalSendEnabled?'#25D366':'#e74c3c'}">${k.globalSendEnabled?'ON':'OFF'}</div><div class="lbl">Send Status</div></div>
        <div class="stat"><div class="num" style="color:${k.autoReplyEnabled?'#25D366':'#f39c12'}">${k.autoReplyEnabled?'ON':'OFF'}</div><div class="lbl">Auto-Reply</div></div>`;
    }catch(e){}
}

// â”€â”€ Pipeline â”€â”€
async function loadPipeline(target='pipelineOverview'){
    try{const r=await(await fetch(A+'/pipeline')).json();if(!r.success)return;
    const el=document.getElementById(target);el.innerHTML='';
    const colors={INTRO:'#3498db',QUALIFYING:'#f39c12',VALUE_DELIVERY:'#9b59b6',BOOKING:'#25D366',FOLLOW_UP:'#e67e22',WON:'#2ecc71',LOST:'#e74c3c',DND:'#555'};
    for(const[stage,list]of Object.entries(r.pipeline)){
        el.innerHTML+=`<div class="stage-card" onclick="showStageContacts('${stage}')">
            <div class="count" style="color:${colors[stage]||'#fff'}">${list.length}</div><div class="name">${stage}</div></div>`;
    }
    }catch(e){}
}

async function showStageContacts(stage){
    document.getElementById('stageFilter').value=stage;
    try{const r=await(await fetch(A+'/pipeline')).json();
    const list=r.pipeline[stage]||[];
    const tb=document.getElementById('stageContacts');tb.innerHTML='';
    list.forEach(c=>{tb.innerHTML+=contactRow(c)});
    }catch(e){}
}

// â”€â”€ Contacts â”€â”€
function contactRow(c){
    const consent={UNKNOWN:'badge-gray',SOFT_OPTIN_SENT:'badge-blue',OPTED_IN:'badge-green',DND:'badge-red'};
    const botStatus=c.bot_paused?'â¸ï¸':'ğŸ¤–';
    return `<tr>
        <td>${c.phone}</td><td>${c.name||'-'}</td>
        <td><span class="badge badge-blue">${c.pipeline_stage||'INTRO'}</span></td>
        <td><span class="badge ${consent[c.consent_status]||'badge-gray'}">${c.consent_status||'?'}</span></td>
        <td>${c.risk_score||0}</td>
        <td>${botStatus}</td>
        <td>
            <button class="btn-sm btn-outline" onclick="viewContact('${c.phone}')">View</button>
            <button class="btn-sm btn-warning" onclick="takeover('${c.phone}')">ğŸ‘¤</button>
        </td></tr>`;
}

async function loadContacts(){
    try{const r=await(await fetch(A+'/contacts')).json();
    const tb=document.getElementById('contactsTable');tb.innerHTML='';
    (r.contacts||[]).forEach(c=>{tb.innerHTML+=contactRow(c)});
    }catch(e){}
}

async function addContact(){
    await fetch(A+'/contacts',{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({phone:document.getElementById('cPhone').value,name:document.getElementById('cName').value,company:document.getElementById('cCompany').value})});
    loadContacts();loadKPIs();
}

async function uploadCSV(input){
    if(!input.files[0])return;
    const fd=new FormData();fd.append('file',input.files[0]);
    fd.append('pitch_project',document.getElementById('batchProject').value);
    fd.append('batch_type',document.getElementById('batchType').value);
    const r=await(await fetch(A+'/contacts/batch-upload',{method:'POST',body:fd})).json();
    alert(r.message);loadContacts();loadKPIs();
}

// â”€â”€ View Contact (modal with CCB) â”€â”€
async function viewContact(phone){
    const[cRes,convRes,evRes]=await Promise.all([
        fetch(A+'/contacts/'+phone+'/ccb').then(r=>r.json()),
        fetch(A+'/conversations/'+phone).then(r=>r.json()),
        fetch(A+'/events/'+phone).then(r=>r.json())
    ]);
    const c=cRes.contact||{};const ccb=cRes.ccb;
    let html=`<div class="grid"><div>
        <p><strong>Phone:</strong> ${c.phone}</p><p><strong>Name:</strong> ${c.name||'-'}</p>
        <p><strong>Stage:</strong> <span class="badge badge-blue">${c.pipeline_stage}</span></p>
        <p><strong>Consent:</strong> ${c.consent_status}</p><p><strong>Risk:</strong> ${c.risk_score||0}</p>
        <p><strong>Bot:</strong> ${c.bot_paused?'â¸ï¸ Paused':'ğŸ¤– Active'}</p>
        <div style="margin-top:10px">
            <button class="btn-sm" onclick="takeover('${phone}')">ğŸ‘¤ Human Takeover</button>
            <button class="btn-sm" onclick="resumeBot('${phone}')">ğŸ¤– Resume Bot</button>
            <button class="btn-sm btn-danger" onclick="setDND('${phone}')">ğŸš« DND</button>
        </div></div>
        <div><h4 style="color:#25D366;margin-bottom:8px">ğŸ“Š CCB (Conclusion)</h4>
        ${ccb?`<pre>${JSON.stringify(ccb,null,2)}</pre>`:'<p style="opacity:.5">No CCB yet</p>'}</div></div>
        <div style="margin-top:15px"><h4 style="color:#25D366;margin-bottom:8px">ğŸ’¬ Conversations</h4>`;
    (convRes.conversations||[]).slice(0,20).forEach(m=>{
        html+=`<div class="msg ${m.direction==='incoming'?'in':'out'}">${m.message}<br><small>${m.created_at}</small></div>`;
    });
    html+=`</div><div style="margin-top:15px"><h4 style="color:#25D366;margin-bottom:8px">ğŸ“‹ Events</h4>`;
    (evRes.events||[]).slice(0,15).forEach(e=>{
        html+=`<div class="event"><span class="type">${e.event_type}</span><span style="opacity:.5">${e.created_at}</span></div>`;
    });
    html+='</div>';
    document.getElementById('modalTitle').textContent=`${c.name||c.phone}`;
    document.getElementById('modalContent').innerHTML=html;
    document.getElementById('modal').style.display='block';
}
function closeModal(){document.getElementById('modal').style.display='none'}

// â”€â”€ Human Takeover â”€â”€
async function takeover(p){await fetch(A+'/contacts/'+p+'/takeover',{method:'POST'});alert('Bot paused for '+p);loadContacts();loadKPIs();}
async function resumeBot(p){await fetch(A+'/contacts/'+p+'/resume-bot',{method:'POST'});alert('Bot resumed for '+p);loadContacts();}
async function setDND(p){if(!confirm('Set DND?'))return;await fetch(A+'/contacts/'+p+'/dnd',{method:'POST'});alert('DND set');loadContacts();}

async function loadHumanRequired(){
    try{const r=await(await fetch(A+'/human-required')).json();
    const el=document.getElementById('humanList');
    if(!r.contacts?.length){el.innerHTML='<p style="opacity:.5">None</p>';return}
    el.innerHTML='';r.contacts.forEach(c=>{
        el.innerHTML+=`<div style="padding:8px;margin:4px 0;background:#1a0a0a;border-radius:4px;display:flex;justify-content:space-between;align-items:center">
            <span>${c.name||c.phone} (risk: ${c.risk_score})</span>
            <button class="btn-sm" onclick="viewContact('${c.phone}')">View</button></div>`;
    });}catch(e){}
}

// â”€â”€ Events â”€â”€
async function loadEvents(){
    const phone=document.getElementById('evPhone').value;
    const url=phone?A+'/events/'+phone:A+'/events';
    try{const r=await(await fetch(url)).json();
    const el=document.getElementById('eventsList');el.innerHTML='';
    (r.events||[]).forEach(e=>{
        el.innerHTML+=`<div class="event"><span class="type">${e.event_type}</span><span>${e.phone||''}</span><span style="opacity:.5">${e.created_at}</span></div>`;
    });}catch(e){}
}

async function loadRecentEvents(){
    try{const r=await(await fetch(A+'/events')).json();
    const el=document.getElementById('recentEvents');el.innerHTML='';
    (r.events||[]).slice(0,10).forEach(e=>{
        el.innerHTML+=`<div class="event"><span class="type">${e.event_type}</span><span>${e.phone||''}</span><span style="opacity:.5">${e.created_at}</span></div>`;
    });}catch(e){}
}

// â”€â”€ Send â”€â”€
async function sendMsg(){
    const p=document.getElementById('sendPhone').value,m=document.getElementById('sendMsg').value;
    if(!p||!m)return alert('Enter phone + message');
    const r=await(await fetch(A+'/messages/send',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone:p,message:m})})).json();
    alert(r.success?'Sent!':'Error: '+r.error);if(r.success)document.getElementById('sendMsg').value='';
}
document.getElementById('sendMsg')?.addEventListener('input',function(){
    document.getElementById('cc').textContent=this.value.length;
    document.getElementById('pc').textContent=Math.max(1,Math.ceil(this.value.length/70));
});

// â”€â”€ Knowledge â”€â”€
async function loadKB(){
    try{const r=await(await fetch(A+'/knowledge')).json();
    const tb=document.getElementById('kbTable');tb.innerHTML='';
    (r.knowledge||[]).forEach(k=>{tb.innerHTML+=`<tr><td>${k.category}</td><td>${k.question||'-'}</td><td>${(k.answer||'').substring(0,60)}</td>
        <td><button class="btn-sm btn-danger" onclick="delKB(${k.id})">X</button></td></tr>`});
    }catch(e){}
}
async function addKB(){
    await fetch(A+'/knowledge',{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({category:document.getElementById('kbCat').value,question:document.getElementById('kbQ').value,answer:document.getElementById('kbA').value,keywords:document.getElementById('kbKW').value})});
    loadKB();loadKPIs();
}
async function delKB(id){await fetch(A+'/knowledge/'+id,{method:'DELETE'});loadKB();}

// â”€â”€ Settings / Kill Switch â”€â”€
async function loadSettings(){
    try{const r=await(await fetch(A+'/settings')).json();
    document.getElementById('sendStatus').innerHTML=r.globalSendEnabled?'<span class="badge badge-green">SENDING ON</span>':'<span class="badge badge-red">SENDING OFF</span>';
    document.getElementById('arStatus').innerHTML=r.autoReplyEnabled?'<span class="badge badge-green">ON</span>':'<span class="badge badge-orange">OFF</span>';
    const el=document.getElementById('settingsList');el.innerHTML='';
    (r.settings||[]).forEach(s=>{el.innerHTML+=`<div style="padding:4px 0;font-size:12px"><strong>${s.key}:</strong> ${s.value}</div>`});
    }catch(e){}
}
async function emergencyStop(){if(!confirm('ğŸš¨ STOP ALL SENDING?'))return;await fetch(A+'/kill-switch/stop',{method:'POST'});loadSettings();loadKPIs();alert('EMERGENCY STOP activated');}
async function resumeSend(){await fetch(A+'/kill-switch/resume',{method:'POST'});loadSettings();loadKPIs();}
async function toggleAutoReply(){
    const r=await(await fetch(A+'/settings')).json();
    await fetch(A+'/settings',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({key:'auto_reply_enabled',value:r.autoReplyEnabled?'false':'true'})});
    loadSettings();loadKPIs();
}

// â”€â”€ QR â”€â”€
async function loadQR(){
    try{const r=await(await fetch(A+'/qr')).json();
    const s=document.getElementById('qrStatus'),i=document.getElementById('qrImg');
    if(r.connected){s.textContent='âœ… Connected';s.style.color='#25D366';i.style.display='none'}
    else if(r.qrImage){s.textContent='ğŸ“± Scan QR:';i.src=r.qrImage;i.style.display='block'}
    else{s.textContent='â³ Waiting...';i.style.display='none'}
    }catch(e){document.getElementById('qrStatus').textContent='Server offline'}
}

// â”€â”€ Tab switching â”€â”€
function show(name){
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById(name+'-panel').classList.add('active');
    if(name==='contacts')loadContacts();
    if(name==='pipeline'){loadPipeline('pipelineDetailed');}
    if(name==='kb')loadKB();
    if(name==='events')loadEvents();
    if(name==='settings')loadSettings();
    if(name==='connect')loadQR();
    if(name==='dash'){loadPipeline();loadHumanRequired();loadRecentEvents();}
}

// â”€â”€ Init â”€â”€
checkStatus();loadKPIs();loadPipeline();loadHumanRequired();loadRecentEvents();
setInterval(checkStatus,5000);setInterval(loadKPIs,10000);setInterval(loadQR,4000);
</script>
</body>
</html>