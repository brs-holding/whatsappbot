<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WhatsApp Sales Operator â€” Dashboard</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#0a0a1a;color:#e0e0e0;min-height:100vh}
.container{max-width:1500px;margin:0 auto;padding:15px}
header{background:#111;padding:15px 20px;border-radius:10px;margin-bottom:15px;display:flex;justify-content:space-between;align-items:center;border:1px solid #222}
header h1{color:#25D366;font-size:20px}
.status{display:flex;align-items:center;gap:8px;font-size:13px}
.dot{width:10px;height:10px;border-radius:50%;background:#f44}
.dot.on{background:#25D366}
.tabs{display:flex;gap:6px;margin-bottom:15px;flex-wrap:wrap}
.tab{padding:10px 18px;background:#151525;border:1px solid #222;color:#aaa;border-radius:6px;cursor:pointer;font-size:13px;transition:.2s}
.tab:hover,.tab.active{background:#25D366;color:#000;border-color:#25D366}
.panel{display:none;background:#111;padding:18px;border-radius:10px;border:1px solid #222}
.panel.active{display:block}
.card{background:#0d1a30;padding:16px;border-radius:8px;margin-bottom:14px;border:1px solid #1a2a40}
.card h3{margin-bottom:12px;color:#25D366;font-size:15px}
input,textarea,select{width:100%;padding:10px;border:1px solid #222;border-radius:5px;background:#0a0a1a;color:#e0e0e0;margin-bottom:8px;font-size:13px}
button{padding:10px 20px;background:#25D366;border:none;border-radius:5px;color:#000;cursor:pointer;font-weight:bold;font-size:13px;transition:.2s}
button:hover{background:#128C7E;color:#fff}
.btn-danger{background:#e74c3c;color:#fff}
.btn-danger:hover{background:#c0392b}
.btn-warning{background:#f39c12;color:#000}
.btn-sm{padding:6px 12px;font-size:12px}
.btn-outline{background:transparent;border:1px solid #25D366;color:#25D366}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
th,td{padding:10px;text-align:left;border-bottom:1px solid #1a2a40}
th{color:#25D366;font-size:12px;text-transform:uppercase}
.badge{padding:3px 8px;border-radius:3px;font-size:11px;font-weight:bold}
.badge-green{background:#25D366;color:#000}
.badge-blue{background:#3498db;color:#fff}
.badge-orange{background:#f39c12;color:#000}
.badge-red{background:#e74c3c;color:#fff}
.badge-gray{background:#555;color:#fff}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:14px}
.stats{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;margin-bottom:15px}
.stat{background:#0d1a30;padding:14px;border-radius:8px;text-align:center;border:1px solid #1a2a40}
.stat .num{font-size:28px;font-weight:bold;color:#25D366}
.stat .lbl{font-size:11px;opacity:.6;margin-top:4px}
.pipeline-row{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:8px;margin:12px 0}
.stage-card{background:#0d1a30;padding:12px;border-radius:6px;text-align:center;border:1px solid #1a2a40;cursor:pointer;transition:.2s}
.stage-card:hover{border-color:#25D366}
.stage-card .count{font-size:24px;font-weight:bold;color:#25D366}
.stage-card .name{font-size:11px;opacity:.7;margin-top:4px}
.msg{padding:8px 12px;margin:4px 0;border-radius:6px;font-size:13px;max-width:85%}
.msg.in{background:#0d1a30}
.msg.out{background:#0a3d2a;margin-left:auto}
.msg small{opacity:.5;font-size:10px}
.event{padding:6px 10px;margin:3px 0;border-radius:4px;font-size:12px;background:#0d1a30;display:flex;justify-content:space-between}
.event .type{color:#25D366;font-weight:bold}
.file-upload{border:2px dashed #25D366;padding:20px;text-align:center;border-radius:8px;cursor:pointer;margin-bottom:10px;font-size:13px}
.file-upload:hover{background:rgba(37,211,102,.05)}
.qr-section{text-align:center;padding:30px}
.qr-section img{max-width:280px;margin:15px auto;display:block}
.kill-switch{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
pre{background:#0a0a1a;padding:12px;border-radius:6px;overflow-x:auto;font-size:12px;max-height:400px;overflow-y:auto;border:1px solid #222}
.pfp{width:60px;height:60px;border-radius:50%;object-fit:cover;border:2px solid #25D366;background:#222}
.pfp-sm{width:32px;height:32px;border-radius:50%;object-fit:cover;border:1px solid #333;background:#222;vertical-align:middle;margin-right:6px}
.contact-header{display:flex;align-items:center;gap:15px;margin-bottom:15px}
.chat-box{max-height:350px;overflow-y:auto;padding:10px;background:#0a0a1a;border-radius:8px;border:1px solid #222;margin:10px 0}
.chat-input{display:flex;gap:8px;margin-top:8px}
.chat-input input{flex:1;margin:0}
.chat-input button{white-space:nowrap}
.variation{padding:8px 12px;margin:4px 0;background:#0d1a30;border-radius:6px;font-size:13px;border-left:3px solid #25D366}
@media(max-width:768px){.stats{grid-template-columns:repeat(2,1fr)}.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
<header>
    <h1>ğŸ“± WhatsApp Sales Operator</h1>
    <div class="status" style="display:flex;align-items:center;gap:12px">
        <span class="dot" id="dot"></span>
        <span id="statusTxt">...</span>
        <span id="liveNumber" style="font-size:14px;font-weight:bold;color:#25D366"></span>
        <button class="btn-sm btn-danger" id="disconnectBtn" style="display:none" onclick="disconnectWA()">Disconnect</button>
        <button class="btn-sm" id="reconnectBtn" style="display:none" onclick="reconnectWA()">ğŸ”„ New Number</button>
    </div>
</header>

<div class="stats" id="kpiBar"></div>

<div class="tabs">
    <button class="tab active" onclick="show('dash')">ğŸ“Š Dashboard</button>
    <button class="tab" onclick="show('pipeline')">ğŸ”„ Pipeline</button>
    <button class="tab" onclick="show('contacts')">ğŸ“‡ Contacts</button>
    <button class="tab" onclick="show('outreach')">ğŸš€ Outreach</button>
    <button class="tab" onclick="show('send')">ğŸ“¤ Send</button>
    <button class="tab" onclick="show('kb')">ğŸ“š Knowledge</button>
    <button class="tab" onclick="show('events')">ğŸ“‹ Events</button>
    <button class="tab" onclick="show('settings')">âš™ï¸ Settings</button>
    <button class="tab" onclick="show('connect')">ğŸ”— Connect</button>
</div>

<!-- Dashboard -->
<div class="panel active" id="dash-panel">
    <div class="card"><h3>ğŸ”„ Pipeline Overview</h3><div class="pipeline-row" id="pipelineOverview"></div></div>
    <div class="grid">
        <div class="card"><h3>ğŸš¨ Needs Human Attention</h3><div id="humanList"></div></div>
        <div class="card"><h3>ğŸ“‹ Recent Events</h3><div id="recentEvents"></div></div>
    </div>
</div>

<!-- Pipeline -->
<div class="panel" id="pipeline-panel">
    <div class="card"><h3>ğŸ”„ Pipeline Stages</h3><div class="pipeline-row" id="pipelineDetailed"></div></div>
    <div class="card"><h3>Contacts in Stage</h3>
        <input type="text" id="stageFilter" placeholder="Click a stage above to filter..." readonly>
        <table><thead><tr><th></th><th>Phone</th><th>Name</th><th>Stage</th><th>Consent</th><th>Actions</th></tr></thead>
        <tbody id="stageContacts"></tbody></table>
    </div>
</div>

<!-- Contacts -->
<div class="panel" id="contacts-panel">
    <div class="grid">
        <div class="card" style="grid-column:1/-1">
            <h3>ğŸš€ Add Numbers & Start Outreach</h3>
            <p style="font-size:13px;opacity:.6;margin-bottom:12px">Paste phone numbers below â€” outreach starts automatically with unique opener variations</p>
            <textarea id="bulkPhones" rows="4" placeholder="Paste phone numbers here (comma or line separated)&#10;e.g. 436641142284, 436641066160&#10;or one per line" style="font-size:14px"></textarea>
            <div style="display:flex;gap:10px;margin-top:8px;flex-wrap:wrap;align-items:center">
                <button onclick="showOutreachConfirm()" style="font-size:15px;padding:12px 25px">ğŸš€ Add & Start Outreach</button>
                <span id="bulkCount" style="font-size:13px;opacity:.6"></span>
            </div>
            <div id="bulkResult" style="margin-top:10px;font-size:13px"></div>
        </div>
    </div>
    <div class="grid">
        <div class="card"><h3>ğŸ“ CSV Import</h3>
            <div class="file-upload" onclick="document.getElementById('csvFile').click()">ğŸ“ Upload CSV (phone,name,company,email)</div>
            <input type="file" id="csvFile" accept=".csv" style="display:none" onchange="uploadCSV(this)">
            <input id="batchProject" placeholder="Pitch project"><input id="batchType" placeholder="Batch type">
        </div>
    </div>
    <div class="card"><h3>ğŸ“‹ All Contacts</h3>
        <input id="contactSearch" placeholder="ğŸ” Search contacts..." oninput="filterContacts(this.value)">
        <table><thead><tr><th></th><th>Phone</th><th>Name</th><th>Stage</th><th>Consent</th><th>Bot</th><th>Actions</th></tr></thead>
        <tbody id="contactsTable"></tbody></table>
    </div>
</div>

<!-- Outreach -->
<div class="panel" id="outreach-panel">
    <div class="card"><h3>ğŸš€ Outreach Campaign</h3>
        <p style="font-size:13px;opacity:.7;margin-bottom:10px">Create campaigns with unique AI-generated opener variations for each contact</p>
        <label style="font-size:12px;color:#25D366">Opener Template:</label>
        <textarea id="openerTemplate" rows="2" placeholder="e.g. Ich hab gesehen, dass du in der M3 Community aktiv bist. Wollte fragen, ob du auch fÃ¼r andere MÃ¶glichkeiten offen bist."></textarea>
        <div class="grid">
            <div>
                <label style="font-size:12px;color:#25D366">Phone Numbers (comma-separated):</label>
                <textarea id="outreachPhones" rows="3" placeholder="4917612345678, 4915123456789, ..."></textarea>
            </div>
            <div>
                <input id="outBatchType" placeholder="Batch type (e.g. crypto_m3)">
                <input id="outProject" placeholder="Pitch project (e.g. M3)">
                <select id="outLanguage"><option value="German">ğŸ‡©ğŸ‡ª German</option><option value="English">ğŸ‡¬ğŸ‡§ English</option><option value="Spanish">ğŸ‡ªğŸ‡¸ Spanish</option></select>
            </div>
        </div>
        <div style="display:flex;gap:10px;margin-top:10px">
            <button onclick="previewOutreach()">ğŸ‘ï¸ Preview Variations</button>
            <button onclick="startOutreach()" style="background:#e67e22">ğŸš€ Start Campaign</button>
        </div>
    </div>
    <div class="card"><h3>ğŸ‘ï¸ Preview</h3><div id="outreachPreview"><p style="opacity:.5">Click "Preview Variations" to see AI-generated opener variations</p></div></div>
    <div class="card"><h3>ğŸ“Š Campaign Status</h3><div id="outreachStatus"><p style="opacity:.5">No active campaign</p></div></div>
</div>

<!-- Send -->
<div class="panel" id="send-panel">
    <div class="card"><h3>ğŸ“¤ Send Message</h3>
        <input id="sendPhone" placeholder="Phone number">
        <textarea id="sendMsg" rows="3" placeholder="Message..."></textarea>
        <div style="font-size:12px;opacity:.6;margin-bottom:8px">Chars: <span id="cc">0</span> | Parts: <span id="pc">1</span></div>
        <button onclick="sendMsg()">Send</button>
    </div>
</div>

<!-- Knowledge -->
<div class="panel" id="kb-panel">
    <div class="card"><h3>â• Add Knowledge</h3>
        <select id="kbCat"><option value="general">General</option><option value="pricing">Pricing</option><option value="services">Services</option><option value="faq">FAQ</option><option value="company">Company</option><option value="objection">Objection Response</option></select>
        <input id="kbQ" placeholder="Question (optional)">
        <textarea id="kbA" rows="2" placeholder="Answer / Information"></textarea>
        <input id="kbKW" placeholder="Keywords (comma separated)">
        <button onclick="addKB()">Add</button>
    </div>
    <div class="card"><h3>ğŸ“š Knowledge Base</h3>
        <table><thead><tr><th>Cat</th><th>Q</th><th>Answer</th><th>X</th></tr></thead><tbody id="kbTable"></tbody></table>
    </div>
</div>

<!-- Events -->
<div class="panel" id="events-panel">
    <div class="card"><h3>ğŸ“‹ Event Timeline</h3>
        <input id="evPhone" placeholder="Filter by phone (optional)">
        <button onclick="loadEvents()">Load Events</button>
        <div id="eventsList" style="margin-top:10px;max-height:500px;overflow-y:auto"></div>
    </div>
</div>

<!-- Settings -->
<div class="panel" id="settings-panel">
    <div class="card"><h3>ğŸ›¡ï¸ Kill Switch</h3>
        <div class="kill-switch">
            <button class="btn-danger" onclick="emergencyStop()">ğŸš¨ EMERGENCY STOP</button>
            <button onclick="resumeSend()">âœ… Resume Sending</button>
            <span id="sendStatus"></span>
        </div>
    </div>
    <div class="grid">
        <div class="card"><h3>âš™ï¸ Auto-Reply</h3>
            <button id="arBtn" onclick="toggleAutoReply()">Toggle Auto-Reply</button>
            <span id="arStatus"></span>
        </div>
        <div class="card"><h3>ğŸ“Š System Settings</h3><div id="settingsList"></div></div>
    </div>
</div>

<!-- Connect -->
<div class="panel" id="connect-panel">
    <div class="card"><h3>ğŸ”— Connect WhatsApp</h3>
        <div class="qr-section">
            <p id="qrStatus">Loading...</p>
            <img id="qrImg" style="display:none">
        </div>
    </div>
</div>

<!-- Contact Detail Modal -->
<div id="modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.85);z-index:999;overflow-y:auto">
    <div style="max-width:800px;margin:30px auto;background:#111;border-radius:12px;padding:24px;border:1px solid #222">
        <div style="display:flex;justify-content:space-between;align-items:center">
            <h3 id="modalTitle" style="color:#25D366"></h3>
            <button class="btn-sm btn-outline" onclick="closeModal()">âœ• Close</button>
        </div>
        <div id="modalContent" style="margin-top:15px"></div>
    </div>
</div>
</div>

<script>
const A='/api';
let allContactsCache=[];

// â”€â”€ Status â”€â”€
async function checkStatus(){
    try{const r=await(await fetch(A+'/status')).json();
    document.getElementById('dot').className='dot'+(r.connected?' on':'');
    document.getElementById('statusTxt').textContent=r.connected?'Connected':'Disconnected';
    const numEl=document.getElementById('liveNumber');
    const dcBtn=document.getElementById('disconnectBtn');
    const rcBtn=document.getElementById('reconnectBtn');
    if(r.connected && r.myNumber){
        numEl.textContent='ğŸ“± +'+r.myNumber;
        dcBtn.style.display='inline-block';
        rcBtn.style.display='inline-block';
    }else{
        numEl.textContent='';
        dcBtn.style.display='none';
        rcBtn.style.display=r.connected?'none':'inline-block';
    }
    }catch(e){document.getElementById('statusTxt').textContent='Offline'}
}

async function disconnectWA(){
    if(!confirm('Disconnect WhatsApp? You will need to scan QR again.'))return;
    const r=await(await fetch(A+'/disconnect',{method:'POST'})).json();
    alert(r.message||r.error);checkStatus();
}

async function reconnectWA(){
    if(!confirm('Switch number? Current session will be destroyed.'))return;
    const r=await(await fetch(A+'/reconnect',{method:'POST'})).json();
    alert(r.message||r.error);
    // Switch to Connect tab to show QR
    show('connect');checkStatus();
}

// â”€â”€ KPIs â”€â”€
async function loadKPIs(){
    try{const r=await(await fetch(A+'/kpis')).json();if(!r.success)return;const k=r.kpis;
    document.getElementById('kpiBar').innerHTML=`
        <div class="stat"><div class="num">${k.totalContacts}</div><div class="lbl">Contacts</div></div>
        <div class="stat"><div class="num">${k.messagesSent}</div><div class="lbl">Sent</div></div>
        <div class="stat"><div class="num">${k.messagesReceived}</div><div class="lbl">Received</div></div>
        <div class="stat"><div class="num">${k.humanRequired}</div><div class="lbl">âš ï¸ Human</div></div>
        <div class="stat"><div class="num">${k.escalations}</div><div class="lbl">ğŸš¨ Escalations</div></div>
        <div class="stat"><div class="num">${k.blocked}</div><div class="lbl">ğŸ›¡ï¸ Blocked</div></div>
        <div class="stat"><div class="num" style="color:${k.globalSendEnabled?'#25D366':'#e74c3c'}">${k.globalSendEnabled?'ON':'OFF'}</div><div class="lbl">Send</div></div>
        <div class="stat"><div class="num" style="color:${k.autoReplyEnabled?'#25D366':'#f39c12'}">${k.autoReplyEnabled?'ON':'OFF'}</div><div class="lbl">Auto-Reply</div></div>`;
    }catch(e){}
}

// â”€â”€ Pipeline â”€â”€
async function loadPipeline(target='pipelineOverview'){
    try{const r=await(await fetch(A+'/pipeline')).json();if(!r.success)return;
    const el=document.getElementById(target);el.innerHTML='';
    const colors={INTRO:'#3498db',QUALIFYING:'#f39c12',VALUE_DELIVERY:'#9b59b6',BOOKING:'#25D366',FOLLOW_UP:'#e67e22',WON:'#2ecc71',LOST:'#e74c3c',DND:'#555'};
    for(const[stage,list]of Object.entries(r.pipeline)){
        el.innerHTML+=`<div class="stage-card" onclick="showStageContacts('${stage}')">
            <div class="count" style="color:${colors[stage]||'#fff'}">${list.length}</div><div class="name">${stage}</div></div>`;
    }}catch(e){}
}

async function showStageContacts(stage){
    document.getElementById('stageFilter').value=stage;
    try{const r=await(await fetch(A+'/pipeline')).json();
    const list=r.pipeline[stage]||[];
    const tb=document.getElementById('stageContacts');tb.innerHTML='';
    list.forEach(c=>{tb.innerHTML+=contactRow(c)});
    }catch(e){}
}

// â”€â”€ Contacts â”€â”€
function contactRow(c){
    const consent={UNKNOWN:'badge-gray',SOFT_OPTIN_SENT:'badge-blue',OPTED_IN:'badge-green',DND:'badge-red'};
    const botStatus=c.bot_paused?'â¸ï¸':'ğŸ¤–';
    return `<tr>
        <td><img class="pfp-sm" src="" data-phone="${c.phone}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2232%22 height=%2232%22><circle cx=%2216%22 cy=%2216%22 r=%2216%22 fill=%22%23333%22/><text x=%2216%22 y=%2221%22 text-anchor=%22middle%22 fill=%22%23888%22 font-size=%2214%22>ğŸ‘¤</text></svg>'"></td>
        <td>${c.phone}</td><td>${c.name||'-'}</td>
        <td><span class="badge badge-blue">${c.pipeline_stage||'INTRO'}</span></td>
        <td><span class="badge ${consent[c.consent_status]||'badge-gray'}">${c.consent_status||'?'}</span></td>
        <td>${botStatus}</td>
        <td>
            <button class="btn-sm btn-outline" onclick="viewContact('${c.phone}')">ğŸ‘ï¸ CRM</button>
            <button class="btn-sm btn-warning" onclick="takeover('${c.phone}')">ğŸ‘¤</button>
        </td></tr>`;
}

async function loadContacts(){
    try{const r=await(await fetch(A+'/contacts')).json();
    allContactsCache=r.contacts||[];
    renderContacts(allContactsCache);
    }catch(e){}
}

function renderContacts(list){
    const tb=document.getElementById('contactsTable');tb.innerHTML='';
    list.forEach(c=>{tb.innerHTML+=contactRow(c)});
    // Load profile pics
    setTimeout(()=>loadProfilePics(),100);
}

function filterContacts(q){
    if(!q){renderContacts(allContactsCache);return}
    q=q.toLowerCase();
    renderContacts(allContactsCache.filter(c=>(c.phone||'').includes(q)||(c.name||'').toLowerCase().includes(q)||(c.company||'').toLowerCase().includes(q)));
}

async function loadProfilePics(){
    const imgs=document.querySelectorAll('.pfp-sm[data-phone]');
    imgs.forEach(async img=>{
        const phone=img.dataset.phone;
        try{
            const r=await fetch(A+'/contacts/'+phone+'/pfp').then(r=>r.json());
            if(r.pfp)img.src=r.pfp;
        }catch(e){}
    });
}

async function addContact(){
    await fetch(A+'/contacts',{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({phone:document.getElementById('cPhone').value,name:document.getElementById('cName').value,company:document.getElementById('cCompany').value})});
    document.getElementById('cPhone').value='';document.getElementById('cName').value='';document.getElementById('cCompany').value='';
    loadContacts();loadKPIs();
}

async function bulkAdd(){
    const phones=document.getElementById('bulkPhones').value;
    if(!phones.trim())return alert('Enter phone numbers');
    const r=await(await fetch(A+'/contacts/bulk-add',{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({phones,batch_type:document.getElementById('bulkBatchType').value,pitch_project:document.getElementById('bulkProject').value})})).json();
    document.getElementById('bulkResult').innerHTML=r.success?`<span style="color:#25D366">âœ… ${r.message}</span>`:`<span style="color:#e74c3c">âŒ ${r.error}</span>`;
    if(r.success){document.getElementById('bulkPhones').value='';loadContacts();loadKPIs();}
}

async function uploadCSV(input){
    if(!input.files[0])return;
    const fd=new FormData();fd.append('file',input.files[0]);
    fd.append('pitch_project',document.getElementById('batchProject').value);
    fd.append('batch_type',document.getElementById('batchType').value);
    const r=await(await fetch(A+'/contacts/batch-upload',{method:'POST',body:fd})).json();
    alert(r.message);loadContacts();loadKPIs();
}

// â”€â”€ View Contact CRM (modal) â”€â”€
async function viewContact(phone){
    const[cRes,convRes,evRes,pfpRes]=await Promise.all([
        fetch(A+'/contacts/'+phone+'/ccb').then(r=>r.json()),
        fetch(A+'/conversations/'+phone).then(r=>r.json()),
        fetch(A+'/events/'+phone).then(r=>r.json()),
        fetch(A+'/contacts/'+phone+'/pfp').then(r=>r.json()).catch(()=>({pfp:null}))
    ]);
    const c=cRes.contact||{};const ccb=cRes.ccb;
    const pfp=pfpRes.pfp||"data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='60' height='60'><circle cx='30' cy='30' r='30' fill='%23333'/><text x='30' y='38' text-anchor='middle' fill='%23888' font-size='24'>ğŸ‘¤</text></svg>";
    
    let html=`<div class="contact-header">
        <img class="pfp" src="${pfp}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2260%22 height=%2260%22><circle cx=%2230%22 cy=%2230%22 r=%2230%22 fill=%22%23333%22/></svg>'">
        <div>
            <h2 style="color:#fff;margin-bottom:4px">${c.name||'Unknown'}</h2>
            <p style="opacity:.7;font-size:14px">ğŸ“± +${c.phone} ${c.company?'â€¢ ğŸ¢ '+c.company:''}</p>
            <div style="margin-top:6px">
                <span class="badge badge-blue">${c.pipeline_stage||'INTRO'}</span>
                <span class="badge ${c.consent_status==='DND'?'badge-red':c.consent_status==='OPTED_IN'?'badge-green':'badge-gray'}">${c.consent_status||'UNKNOWN'}</span>
                <span class="badge ${c.bot_paused?'badge-orange':'badge-green'}">${c.bot_paused?'â¸ï¸ Bot Paused':'ğŸ¤– Bot Active'}</span>
            </div>
        </div>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:15px;flex-wrap:wrap">
        <button class="btn-sm" onclick="takeover('${phone}');closeModal()">ğŸ‘¤ Human Takeover</button>
        <button class="btn-sm" onclick="resumeBot('${phone}');closeModal()">ğŸ¤– Resume Bot</button>
        <button class="btn-sm btn-danger" onclick="setDND('${phone}');closeModal()">ğŸš« DND</button>
    </div>`;

    // Chat section with inline messaging
    html+=`<div class="card"><h3>ğŸ’¬ Conversation</h3><div class="chat-box" id="chatBox">`;
    const convs=(convRes.conversations||[]).slice(0,30);
    if(convs.length===0)html+='<p style="opacity:.5;text-align:center;padding:20px">No messages yet</p>';
    convs.forEach(m=>{
        const time=new Date(m.created_at).toLocaleString('de-DE',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});
        html+=`<div class="msg ${m.direction==='incoming'?'in':'out'}">${m.message}<br><small>${time} â€¢ ${m.direction}</small></div>`;
    });
    html+=`</div>
        <div class="chat-input">
            <input id="modalMsg" placeholder="Type a message..." onkeydown="if(event.key==='Enter')sendFromModal('${phone}')">
            <button onclick="sendFromModal('${phone}')">ğŸ“¤ Send</button>
        </div></div>`;

    // CCB
    html+=`<div class="card"><h3>ğŸ“Š CCB (Customer Conclusion Brief)</h3>
        ${ccb?`<pre>${JSON.stringify(ccb,null,2)}</pre>`:'<p style="opacity:.5">No CCB generated yet</p>'}</div>`;

    // Events
    html+=`<div class="card"><h3>ğŸ“‹ Recent Events</h3><div style="max-height:200px;overflow-y:auto">`;
    (evRes.events||[]).slice(0,15).forEach(e=>{
        html+=`<div class="event"><span class="type">${e.event_type}</span><span style="opacity:.5">${e.created_at}</span></div>`;
    });
    html+='</div></div>';

    document.getElementById('modalTitle').textContent=`${c.name||c.phone}`;
    document.getElementById('modalContent').innerHTML=html;
    document.getElementById('modal').style.display='block';
    // Scroll chat to bottom
    const cb=document.getElementById('chatBox');if(cb)cb.scrollTop=cb.scrollHeight;
}

async function sendFromModal(phone){
    const input=document.getElementById('modalMsg');
    const msg=input.value.trim();if(!msg)return;
    const r=await(await fetch(A+'/messages/send',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone,message:msg})})).json();
    if(r.success){input.value='';viewContact(phone);}else{alert('Error: '+r.error);}
}
function closeModal(){document.getElementById('modal').style.display='none'}

// â”€â”€ Human Takeover â”€â”€
async function takeover(p){await fetch(A+'/contacts/'+p+'/takeover',{method:'POST'});alert('Bot paused for '+p);loadContacts();loadKPIs();}
async function resumeBot(p){await fetch(A+'/contacts/'+p+'/resume-bot',{method:'POST'});alert('Bot resumed for '+p);loadContacts();}
async function setDND(p){if(!confirm('Set DND?'))return;await fetch(A+'/contacts/'+p+'/dnd',{method:'POST'});alert('DND set');loadContacts();}

async function loadHumanRequired(){
    try{const r=await(await fetch(A+'/human-required')).json();
    const el=document.getElementById('humanList');
    if(!r.contacts?.length){el.innerHTML='<p style="opacity:.5">None</p>';return}
    el.innerHTML='';r.contacts.forEach(c=>{
        el.innerHTML+=`<div style="padding:8px;margin:4px 0;background:#1a0a0a;border-radius:4px;display:flex;justify-content:space-between;align-items:center">
            <span>${c.name||c.phone} (risk: ${c.risk_score})</span>
            <button class="btn-sm" onclick="viewContact('${c.phone}')">View</button></div>`;
    });}catch(e){}
}

// â”€â”€ Outreach â”€â”€
async function previewOutreach(){
    const opener=document.getElementById('openerTemplate').value;
    if(!opener)return alert('Enter an opener template');
    const el=document.getElementById('outreachPreview');
    el.innerHTML='<p style="opacity:.7">â³ Generating variations...</p>';
    const phones=document.getElementById('outreachPhones').value;
    const count=phones?phones.split(',').filter(p=>p.trim()).length:5;
    const lang=document.getElementById('outLanguage').value;
    const r=await(await fetch(A+'/outreach/preview',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({opener,count:Math.max(count,3),language:lang})})).json();
    if(r.success){
        el.innerHTML='';
        r.variations.forEach((v,i)=>{el.innerHTML+=`<div class="variation"><strong>#${i+1}:</strong> ${v}</div>`});
    }else{el.innerHTML=`<p style="color:#e74c3c">Error: ${r.error}</p>`}
}

async function startOutreach(){
    const opener=document.getElementById('openerTemplate').value;
    const phonesRaw=document.getElementById('outreachPhones').value;
    if(!opener||!phonesRaw)return alert('Enter opener + phone numbers');
    if(!confirm(`Start outreach campaign?\nThis will send messages with 30-90s delays between each.`))return;
    const phones=phonesRaw.split(',').map(p=>p.trim().replace(/\D/g,'')).filter(p=>p.length>5);
    const el=document.getElementById('outreachStatus');
    el.innerHTML=`<p style="color:#f39c12">ğŸš€ Campaign starting for ${phones.length} contacts...</p>`;
    const r=await(await fetch(A+'/outreach/start',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
        phones,opener,batch_type:document.getElementById('outBatchType').value,pitch_project:document.getElementById('outProject').value,language:document.getElementById('outLanguage').value
    })})).json();
    if(r.success){
        el.innerHTML=`<p style="color:#25D366">âœ… ${r.message}</p><p style="opacity:.7">Batch: ${r.batchId}</p>`;
        r.preview.forEach((p,i)=>{el.innerHTML+=`<div class="variation"><strong>${p.phone}:</strong> ${p.message}</div>`});
    }else{el.innerHTML=`<p style="color:#e74c3c">âŒ ${r.error}</p>`}
}

// â”€â”€ Events â”€â”€
async function loadEvents(){
    const phone=document.getElementById('evPhone').value;
    const url=phone?A+'/events/'+phone:A+'/events';
    try{const r=await(await fetch(url)).json();
    const el=document.getElementById('eventsList');el.innerHTML='';
    (r.events||[]).forEach(e=>{
        el.innerHTML+=`<div class="event"><span class="type">${e.event_type}</span><span>${e.phone||''}</span><span style="opacity:.5">${e.created_at}</span></div>`;
    });}catch(e){}
}

async function loadRecentEvents(){
    try{const r=await(await fetch(A+'/events')).json();
    const el=document.getElementById('recentEvents');el.innerHTML='';
    (r.events||[]).slice(0,10).forEach(e=>{
        el.innerHTML+=`<div class="event"><span class="type">${e.event_type}</span><span>${e.phone||''}</span><span style="opacity:.5">${e.created_at}</span></div>`;
    });}catch(e){}
}

// â”€â”€ Send â”€â”€
async function sendMsg(){
    const p=document.getElementById('sendPhone').value,m=document.getElementById('sendMsg').value;
    if(!p||!m)return alert('Enter phone + message');
    const r=await(await fetch(A+'/messages/send',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone:p,message:m})})).json();
    alert(r.success?'Sent!':'Error: '+r.error);if(r.success)document.getElementById('sendMsg').value='';
}
document.getElementById('sendMsg')?.addEventListener('input',function(){
    document.getElementById('cc').textContent=this.value.length;
    document.getElementById('pc').textContent=Math.max(1,Math.ceil(this.value.length/70));
});

// â”€â”€ Knowledge â”€â”€
async function loadKB(){
    try{const r=await(await fetch(A+'/knowledge')).json();
    const tb=document.getElementById('kbTable');tb.innerHTML='';
    (r.knowledge||[]).forEach(k=>{tb.innerHTML+=`<tr><td>${k.category}</td><td>${k.question||'-'}</td><td>${(k.answer||'').substring(0,60)}</td>
        <td><button class="btn-sm btn-danger" onclick="delKB(${k.id})">X</button></td></tr>`});
    }catch(e){}
}
async function addKB(){
    await fetch(A+'/knowledge',{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({category:document.getElementById('kbCat').value,question:document.getElementById('kbQ').value,answer:document.getElementById('kbA').value,keywords:document.getElementById('kbKW').value})});
    loadKB();
}
async function delKB(id){await fetch(A+'/knowledge/'+id,{method:'DELETE'});loadKB();}

// â”€â”€ Settings / Kill Switch â”€â”€
async function loadSettings(){
    try{const r=await(await fetch(A+'/settings')).json();
    document.getElementById('sendStatus').innerHTML=r.globalSendEnabled?'<span class="badge badge-green">SENDING ON</span>':'<span class="badge badge-red">SENDING OFF</span>';
    document.getElementById('arStatus').innerHTML=r.autoReplyEnabled?'<span class="badge badge-green">ON</span>':'<span class="badge badge-orange">OFF</span>';
    const el=document.getElementById('settingsList');el.innerHTML='';
    (r.settings||[]).forEach(s=>{el.innerHTML+=`<div style="padding:4px 0;font-size:12px"><strong>${s.key}:</strong> ${s.value}</div>`});
    }catch(e){}
}
async function emergencyStop(){if(!confirm('ğŸš¨ STOP ALL SENDING?'))return;await fetch(A+'/kill-switch/stop',{method:'POST'});loadSettings();loadKPIs();alert('EMERGENCY STOP activated');}
async function resumeSend(){await fetch(A+'/kill-switch/resume',{method:'POST'});loadSettings();loadKPIs();}
async function toggleAutoReply(){
    const r=await(await fetch(A+'/settings')).json();
    await fetch(A+'/settings',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({key:'auto_reply_enabled',value:r.autoReplyEnabled?'false':'true'})});
    loadSettings();loadKPIs();
}

// â”€â”€ QR â”€â”€
async function loadQR(){
    try{const r=await(await fetch(A+'/qr')).json();
    const s=document.getElementById('qrStatus'),i=document.getElementById('qrImg');
    if(r.connected){s.textContent='âœ… Connected';s.style.color='#25D366';i.style.display='none'}
    else if(r.qrImage){s.textContent='ğŸ“± Scan QR:';i.src=r.qrImage;i.style.display='block'}
    else{s.textContent='â³ Waiting...';i.style.display='none'}
    }catch(e){document.getElementById('qrStatus').textContent='Server offline'}
}

// â”€â”€ Tab switching â”€â”€
function show(name){
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById(name+'-panel').classList.add('active');
    if(name==='contacts')loadContacts();
    if(name==='pipeline')loadPipeline('pipelineDetailed');
    if(name==='kb')loadKB();
    if(name==='events')loadEvents();
    if(name==='settings')loadSettings();
    if(name==='connect')loadQR();
    if(name==='dash'){loadPipeline();loadHumanRequired();loadRecentEvents();}
}

// â”€â”€ Outreach Confirm Popup â”€â”€
function parsePhoneInput(raw){
    return raw.replace(/\n/g,',').split(',').map(p=>p.trim().replace(/[^0-9]/g,'')).filter(p=>p.length>5);
}

// Live phone counter
document.getElementById('bulkPhones')?.addEventListener('input',function(){
    const phones=parsePhoneInput(this.value);
    document.getElementById('bulkCount').textContent=phones.length>0?`${phones.length} numbers detected`:'';
});

function showOutreachConfirm(){
    const raw=document.getElementById('bulkPhones').value;
    const phones=parsePhoneInput(raw);
    if(phones.length===0)return alert('Paste some phone numbers first');
    
    // Show confirmation popup
    const html=`
        <div style="text-align:center;padding:20px">
            <div style="font-size:48px;margin-bottom:15px">ğŸš€</div>
            <h2 style="color:#25D366;margin-bottom:10px">Start Outreach?</h2>
            <p style="font-size:16px;margin-bottom:20px"><strong>${phones.length}</strong> new M3 community numbers</p>
            <div style="background:#0d1a30;padding:15px;border-radius:8px;margin-bottom:20px;text-align:left">
                <p style="font-size:13px;color:#25D366;margin-bottom:8px">ğŸ“‹ What will happen:</p>
                <p style="font-size:13px;opacity:.8">1. Numbers added to contacts</p>
                <p style="font-size:13px;opacity:.8">2. AI generates unique opener for each</p>
                <p style="font-size:13px;opacity:.8">3. Messages sent with 1-1.5 min delays (25 min break after 15)</p>
                <p style="font-size:13px;opacity:.8">4. Auto follow-up if no reply in 8 min</p>
                <p style="font-size:13px;opacity:.8">5. 3-strike rule on rejections</p>
            </div>
            <div style="background:#0a0a1a;padding:12px;border-radius:6px;margin-bottom:20px;max-height:150px;overflow-y:auto;text-align:left">
                ${phones.map((p,i)=>`<span style="display:inline-block;margin:2px 4px;padding:3px 8px;background:#1a2a40;border-radius:4px;font-size:12px">+${p}</span>`).join('')}
            </div>
            <div style="display:flex;gap:12px;justify-content:center">
                <button onclick="closeModal()" class="btn-outline" style="padding:12px 30px">Cancel</button>
                <button onclick="executeOutreachFromBulk()" style="padding:12px 30px;font-size:15px">ğŸš€ Start Outreach</button>
            </div>
        </div>`;
    
    document.getElementById('modalTitle').textContent='';
    document.getElementById('modalContent').innerHTML=html;
    document.getElementById('modal').style.display='block';
}

async function executeOutreachFromBulk(){
    const raw=document.getElementById('bulkPhones').value;
    const phones=parsePhoneInput(raw);
    
    // Update modal to show progress
    document.getElementById('modalContent').innerHTML=`
        <div style="text-align:center;padding:40px">
            <div style="font-size:48px;margin-bottom:15px">â³</div>
            <h2 style="color:#f39c12;margin-bottom:10px">Generating AI openers...</h2>
            <p style="opacity:.7">Creating unique variations for ${phones.length} contacts</p>
            <div style="margin-top:20px;height:4px;background:#222;border-radius:2px;overflow:hidden">
                <div style="width:30%;height:100%;background:#25D366;animation:progress 2s infinite;border-radius:2px"></div>
            </div>
        </div>
        <style>@keyframes progress{0%{width:10%}50%{width:70%}100%{width:10%}}</style>`;
    
    try{
        const r=await(await fetch(A+'/contacts/bulk-add',{method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({phones:phones.join(','),batch_type:'m3_community',pitch_project:'M3'})})).json();
        
        if(r.success){
            document.getElementById('modalContent').innerHTML=`
                <div style="text-align:center;padding:40px">
                    <div style="font-size:48px;margin-bottom:15px">âœ…</div>
                    <h2 style="color:#25D366;margin-bottom:10px">Outreach Started!</h2>
                    <p style="font-size:16px;margin-bottom:5px">${r.message}</p>
                    <p style="opacity:.6;margin-bottom:20px">Messages sending with 1-1.5 min delays (25 min break after 15)</p>
                    <div style="background:#0d1a30;padding:15px;border-radius:8px;margin-bottom:20px">
                        <p style="font-size:13px;opacity:.8">ğŸ”„ Auto follow-up: every 8 min if no reply</p>
                        <p style="font-size:13px;opacity:.8">ğŸ“Š Track progress on Dashboard & Pipeline tabs</p>
                    </div>
                    <button onclick="closeModal()" style="padding:12px 30px">ğŸ‘ Got it</button>
                </div>`;
            document.getElementById('bulkPhones').value='';
            document.getElementById('bulkCount').textContent='';
            loadContacts();loadKPIs();
        }else{
            document.getElementById('modalContent').innerHTML=`
                <div style="text-align:center;padding:40px">
                    <div style="font-size:48px;margin-bottom:15px">âŒ</div>
                    <h2 style="color:#e74c3c">Error</h2>
                    <p>${r.error||r.message}</p>
                    <button onclick="closeModal()" style="margin-top:15px">Close</button>
                </div>`;
        }
    }catch(e){
        document.getElementById('modalContent').innerHTML=`
            <div style="text-align:center;padding:40px">
                <div style="font-size:48px;margin-bottom:15px">âŒ</div>
                <h2 style="color:#e74c3c">Connection Error</h2>
                <p>${e.message}</p>
                <button onclick="closeModal()" style="margin-top:15px">Close</button>
            </div>`;
    }
}

// â”€â”€ Init â”€â”€
checkStatus();loadKPIs();loadPipeline();loadHumanRequired();loadRecentEvents();
setInterval(checkStatus,5000);setInterval(loadKPIs,10000);setInterval(loadQR,4000);
</script>
</body>
</html>
